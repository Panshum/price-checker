<script>
  let data = [];
  let exportList = [];
  let HEADERS = [];

  window.onload = () => {
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR8UYKgoeAyw1kQ1GC5XbeiIYtInWmVhBnlKgcyXhuz7YxX8MiJ3tWUtC6peD7DOZ0-6UDq4OS89c0Q/pub?gid=635860009&single=true&output=csv&t=' + Date.now();

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        data = results.data;
        if (data.length > 0) {
          HEADERS = Object.keys(data[0]); // ðŸ”¥ å®Œå…¨è·ŸExcel Header
        }
        console.log("Headers:", HEADERS);
      },
      error: function(err) {
        alert("Error loading CSV: " + err.message);
      }
    });
  };

  function searchItem() {
    const code = document.getElementById('itemCodeInput').value.trim();
    const matched = data.filter(row => row['Item Code']?.trim() === code);

    const resultsDiv = document.getElementById('results');

    if (matched.length === 0) {
      resultsDiv.innerHTML = '<div class="alert alert-warning">No matching item found.</div>';
      return;
    }

    let html = `<h5 class="mb-3">Results for: <span class="text-primary">${code}</span></h5>`;
    html += '<div class="table-responsive"><table class="table table-striped table-hover"><thead><tr>';

    // ðŸ”¥ ç”¨Excel Headerç”Ÿæˆ
    HEADERS.forEach(h => {
      html += `<th>${h}</th>`;
    });

    html += '<th>% Change</th><th>Action</th></tr></thead><tbody>';

    let change = '';

    if (matched.length > 1) {
      matched.sort((a, b) => new Date(a.Date) - new Date(b.Date));
      const oldPrice = parseFloat(matched[0]['Price/M']);
      const newPrice = parseFloat(matched[matched.length - 1]['Price/M']);

      if (!isNaN(oldPrice) && oldPrice !== 0) {
        change = (((newPrice - oldPrice) / oldPrice) * 100).toFixed(2) + '%';
      }
    }

    matched.forEach((row, i) => {
      html += '<tr>';

      HEADERS.forEach(h => {
        html += `<td>${row[h] ?? ''}</td>`;
      });

      html += `<td${i === matched.length - 1 ? ' class="highlight"' : ''}>
                ${i === matched.length - 1 ? change : ''}
              </td>`;

      html += `<td>
                <button class='btn btn-sm btn-outline-primary'
                onclick='addToExport(${JSON.stringify(row).replace(/'/g, "&#39;")})'>
                <i class="fas fa-plus"></i> Add
                </button>
               </td>`;

      html += '</tr>';
    });

    html += '</tbody></table></div>';
    resultsDiv.innerHTML = html;
  }

  function addToExport(item) {
    exportList.push(item);
    updateExportTable();
  }

  function updateExportTable() {
    const table = document.getElementById('exportTable');
    const header = document.getElementById('exportHeader');
    const body = table.querySelector('tbody');

    body.innerHTML = '';
    header.innerHTML = '';

    if (exportList.length === 0) return;

    // ðŸ”¥ ä¸€å®šè·ŸåŽŸå§‹Excel Headeré †åº
    HEADERS.forEach(h => {
      header.innerHTML += `<th>${h}</th>`;
    });

    exportList.forEach(row => {
      const tr = document.createElement('tr');

      HEADERS.forEach(h => {
        const td = document.createElement('td');
        td.textContent = row[h] ?? '';
        tr.appendChild(td);
      });

      body.appendChild(tr);
    });
  }

  function downloadExcel() {
    if (exportList.length === 0) {
      alert('No items to export.');
      return;
    }

    const ws = XLSX.utils.json_to_sheet(exportList);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Exported Items');
    XLSX.writeFile(wb, 'exported_items.xlsx');
  }
</script>
